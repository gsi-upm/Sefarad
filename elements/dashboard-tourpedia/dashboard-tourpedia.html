<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/material-search/material-search.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/google-chart-elasticsearch/google-chart.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/yasgui-polymer/yasgui.html">
<link rel="import" href="../../bower_components/reviews-table/reviews-table.html">
<link rel="import" href="../../bower_components/number-chart/number-chart.html">
<link rel="import" href="../../bower_components/leaflet-maps/leaflet-map.html">

<dom-module id="dashboard-tourpedia">

  <style is="custom-style">
    @import url("../../styles/app-theme.html");
  </style>
  <link rel="import" type="css" href="dashboard-tourpedia.css">

  <template>
    <iron-ajax auto
        url="queries.json"
        handle-as="json"
        last-response="{{queries}}"></iron-ajax>
    <iron-ajax auto
        url="/endpoint.json"
        handle-as="json"
        last-response="{{endpoint}}"></iron-ajax>
    <template is="dom-repeat" items="{{ids}}" as="id"> 
      <iron-ajax auto 
        url="{{getName(id)}}"
        handle-as="json"
        on-response="addPlace"></iron-ajax>
    </template>

    <paper-tabs selected="{{selected}}">
      <paper-tab>Dashboard</paper-tab>
      <paper-tab>Sparql Editor</paper-tab>
    </paper-tabs>

    <iron-pages selected="{{selected}}">
      <div>
         <paper-material elevation="3">
          <div style="text-align:center;">Here are some demo webcomponents, explore 
          more in <a href="https://elements.polymer-project.org/" target="_blank">https://elements.polymer-project.org/</a>
          or GSI-UPM components in <a href="https://lab.cluster.gsi.dit.upm.es/sefarad" target="_blank">https://lab.cluster.gsi.dit.upm.es/sefarad</a></div>
        </paper-material>
        <br>
        <br>
        <material-search search-value="{{query}}"></material-search>
        <br>
        <div style="width: 100%; display: inline-block">
          <div style="width: 23%; margin-right: 2.6%; float: left">
            <number-chart 
              icon="info"
              stylebg="bg-red"
              data="{{data}}">
            </number-chart>
          </div>
          <div style="width: 23%; margin-right: 2.6%; float: left">
            <number-chart 
              data="{{data}}"
              object="restaurant"
              title="Restaurants"
              icon="maps:local-dining"
              stylebg="bg-yellow">
            </number-chart>
          </div>
          <div style="width: 23%; margin-right: 2.6%; float: left">
            <number-chart 
              data="{{data}}"
              object="poi"
              title="POIs"
              icon="social:whatshot"
              stylebg="bg-green">
            </number-chart>
          </div>
          <div style="width: 23%; float: left">
            <number-chart 
              icon="maps:hotel"
              data="{{data}}"
              title="Accommodations"
              object="accommodation"
              stylebg="bg-aqua">
            </number-chart>
          </div>
        </div>
        <div style="width: 100%; display: inline-block">
          <div class="chart_container" style="left: 0; float: left">
            <google-chart
              field="category"
              datos="{{data}}"             
              id='pie-chart3'
              extra-id='pie-chart3'
              type='pie'
              filters="{{filters}}"
              icon='room'
              param="{{param}}"
              options='{"title": "Different types of places"}'
              cols='[{"label": "Sentiment", "type": "string"},{"label": "Count", "type": "number"}]'
              rows='[ ["Jan", 31],["Feb", 28],["Mar", 31],["Apr", 30],["May", 31],["Jun", 30] ]'>
            </google-chart>
          </div>
          <div class="chart_container" style="right: 0; float: right">
            <google-chart
              datos="{{data}}"
              field="location"
              id='pie-chart4'
              extra-id='pie-chart4'
              type='pie'
              filters="{{filters}}"
              icon='maps:my-location'
              param='{{param}}'
              options='{"title": "Places at different cities"}'
              cols='[{"label": "Place", "type": "string"},{"label": "Count", "type": "number"}]'
              rows='[ ["Jan", 31],["Feb", 28],["Mar", 31],["Apr", 30],["May", 31],["Jun", 30] ]'>
            </google-chart>
          </div>
        </div>
        <div style="width: 100%">
          <div class="chart_container" style="left: 0; float: left">
           <google-chart
              datos="{{data}}"
              field="numReviews"
              id='column-chart1'
              extra-id='column-chart1'
              type='column'
              filters="{{filters}}"
              icon='maps:rate-review'
              param='{{param}}'
              optionsbi='{"legend": "none"}'
              options='{"title": "Count of number of reviews"}'
              cols='[{"label": "Reviews", "type": "number"},{"label": "Count", "type": "number"}]'
              rows='[ [0, 31],[1, 28],[2, 31],[3, 30],[4, 30],[5, 31],[6, 30] ]'>
            </google-chart>
          </div>
          <div class="chart_container" style="right: 0; float: right">
            <google-chart
              datos="{{data}}"
              field="polarity"
              fields='["category", "location"]'
              id='bar-chart3'
              extra-id='bar-chart3'
              type='bar'
              filters="{{filters}}"
              icon='maps:local-play'
              param='{{param}}'
              optionsbi='{"legend": "none"}'
              options='{"title": "Count of different polarities"}'
              cols='[{"label": "Polarity", "type": "number"},{"label": "Count", "type": "number"}]'
              rows='[ ["Jan", 31],["Feb", 28],["Mar", 31],["Apr", 30],["May", 31],["Jun", 30] ]'>
            </google-chart>
          </div>
            <div style="clear: both"></div>
        </div>
        <div style="width: 100%">
          <div class="chart_container" style="left: 0; float: left">
            <reviews-table 
                data="{{ids}}"
                icon='social:people'>
            </reviews-table>
          </div>
          <div class="chart_container" style="right: 0; float: right"> 
            <leaflet-map fit-to-markers>      
              <template is="dom-repeat" items="[[getPoints(places.*)]]" as="place">      
                <leaflet-marker latitude="{{place.lat}}" longitude="{{place.lng}}" title="{{place.name}}"> 
                    <b>Name:</b>
                    <span>{{place.name}}</span>
                </leaflet-marker>
              </template>
            </leaflet-map>
          </div>
          <div style="clear: both"></div>
        </div>
      </div>
      <div>
        <yasgui-ui
            endpoint="http://fuseki-tourpedia.cluster.gsi.dit.upm.es/tourpedia/query"
            queries="{{queries}}">
        </yasgui-ui>
      </div>
    </iron-pages>
  </template>

  <script>
  var filtered = false;
    Polymer({
      is: 'dashboard-tourpedia',
      properties: {
        selected: {
          type: Number,
          value: 0
        }, 

        ids:{
          type: Array
          /*value: ["481","482","32512","32420","91963","96677","160677","131425","322429","322612"]*/
           
        },

        data:{
          type: Object
        },

        query: {
          type: String,
          observer: '_queryChanged'
        },

        fields: {
          type: Array,
          value: function() { return []; }
        },

        places: {
          type: Array,
          notify: true,
          value: []
        },

        filters: {
          type: Array,
          notify: true,
          value: function() { return []; }
        }
      },
    
      observers: [
      '_filtersChange(filters.*)'
      ],

      ready: function(){
        this.queryDefault();
      },
      
      addPlace: function(event) {
        this.set('places', this.places.concat(event.detail.response))
        console.log(this.places)
      },
      
      getName: function(id) {
        return "http://tour-pedia.org/api/getPlaceDetails?id=" + id
      },
      
      getPoints: function(f) {
        return f.base;
      },

      _queryChanged: function() {
        console.log("_queryChanged")
        this.query ? this.queryChange(this.query) : this.queryDefault();
      },

      queryChange: function(value) {
        console.log("_filtersChange")
        var that = this;
        var client = new $.es.Client({
            hosts: this.host
          });
          client.search({
          // undocumented params are appended to the query string
          index: "tourpedia",
          type: "places",
          body: {
            size: 10,
            query: {
              multi_match: {
                fields: ["category","location"],
                query: this.query

              }
            },
            aggs: {
              category: {
                terms: {
                  field: "category",
                  order: {
                    _count: "desc"
                  }
                }
              },
              location: {
                terms: {
                  field: "location",
                  order: {
                    _count: "desc"
                  }
                }
              },
              numReviews: {
                terms: {
                  field: "numReviews",
                  order: {
                    _count: "desc"
                  }
                }
              },
              polarity: {
                terms: {
                  field: "polarity",
                  order: {
                    _count: "desc"
                  }
                }
              }
            }      
          }
          }).then(function (resp) {
            var myids = []
            resp.hits.hits.forEach(function(entry){myids.push(entry._id)})
            that.ids = myids;
            that.data = resp;
            
        });
        
      },
     
      queryDefault: function() {
        var that = this;
        var client = new $.es.Client({
          hosts: this.host
        });
        client.search({
          // undocumented params are appended to the query string
          index: "tourpedia",
          type: "places",
          body: {
            size: 10,
            query: {
              match_all: {}
            },
            sort: {numReviews: "desc"},
            aggs: {
              category: {
                terms: {
                  field: "category",
                  order: {
                    _count: "desc"
                  }
                }
              },
              location: {
                terms: {
                  field: "location",
                  order: {
                    _count: "desc"
                  }
                }
              },
              numReviews: {
                terms: {
                  field: "numReviews",
                  order: {
                    _count: "desc"
                  }
                }
              },
              polarity: {
                terms: {
                  field: "polarity",
                  order: {
                    _count: "desc"
                  }
                }
              }
            }      
          }
        }).then(function (resp) {
          var myids = []
          resp.hits.hits.forEach(function(entry){myids.push(entry._id)})
          that.ids = myids;
          //console.log(that.ids)
          that.data = resp;
          //console.log(that.data)
        });
      },

      _filtersChange: function() {
        console.log("_filtersChangedash")
        var that = this;
        if(filtered){
          var client = new $.es.Client({
            hosts: this.host
          });
          client.search({
          // undocumented params are appended to the query string
          index: "tourpedia",
          type: "places",
          body: {
            size: 10,
            query: {
              bool: {
                must: this.filters,
              }
            },
            aggs: {
              category: {
                terms: {
                  field: "category",
                  order: {
                    _count: "desc"
                  }
                }
              },
              location: {
                terms: {
                  field: "location",
                  order: {
                    _count: "desc"
                  }
                }
              },
              numReviews: {
                terms: {
                  field: "numReviews",
                  order: {
                    _count: "desc"
                  }
                }
              },
              polarity: {
                terms: {
                  field: "polarity",
                  order: {
                    _count: "desc"
                  }
                }
              }
            }      
          }
          }).then(function (resp) {
            var myids = []
            resp.hits.hits.forEach(function(entry){myids.push(entry._id)})
            that.ids = myids;
            //console.log(that.ids)
            that.data = resp;
            //console.log(that.data)
            
            });
        }
      }
    });
  </script>

</dom-module>
